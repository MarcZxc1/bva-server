// Shopee Clone - Prisma Schema
// Generated from SQL Database Schema

generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================
enum UserRole {
  buyer
  seller
  admin

  @@map("user_role_t")
}

// ==================== MODELS ====================

model AppUser {
  userId       BigInt    @id @default(autoincrement()) @map("user_id")
  username     String    @unique @db.VarChar(60)
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  phoneNumber  String?   @map("phone_number") @db.VarChar(30)
  role         UserRole  @default(buyer)
  coinsBalance Decimal   @default(0) @map("coins_balance") @db.Decimal(12, 2)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  addresses          Address[]
  cartItems          CartItem[]
  coinHistory        CoinHistory[]
  followedShops      FollowedShop[]
  orders             Order[]         @relation("BuyerOrders")
  paymentMethods     PaymentMethod[]
  recentlyViewed     RecentlyViewed[]
  reviews            ProductReview[]
  shops              Shop[]
  userVouchers       UserVoucher[]
  wishlistItems      WishlistItem[]
  chatMessagesAsSender ChatMessage[] @relation("SenderMessages")
  chatSessionsAsBuyer  ChatSession[] @relation("BuyerSessions")
  chatSessionsAsSeller ChatSession[] @relation("SellerSessions")

  @@map("app_user")
}

model Address {
  addressId   BigInt   @id @default(autoincrement()) @map("address_id")
  userId      BigInt?  @map("user_id")
  label       String?  @db.VarChar(60)
  fullAddress String   @map("full_address") @db.Text
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user AppUser? @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("address")
}

model CartItem {
  cartItemId  BigInt    @id @default(autoincrement()) @map("cart_item_id")
  userId      BigInt?   @map("user_id")
  productId   BigInt?   @map("product_id")
  variationId BigInt?   @map("variation_id")
  quantity    Int       @default(1)
  addedAt     DateTime? @default(now()) @map("added_at") @db.Timestamptz(6)

  // Relations
  user      AppUser?           @relation(fields: [userId], references: [userId], onDelete: Cascade)
  product   Product?           @relation(fields: [productId], references: [productId])
  variation ProductVariation?  @relation(fields: [variationId], references: [variationId])

  @@unique([userId, productId, variationId])
  @@index([userId], name: "idx_cart_user")
  @@map("cart_item")
}

model Category {
  categoryId BigInt    @id @default(autoincrement()) @map("category_id")
  parentId   BigInt?   @map("parent_id")
  name       String    @db.VarChar(120)
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [categoryId], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("category")
}

model ChatMessage {
  messageId   BigInt    @id @default(autoincrement()) @map("message_id")
  sessionId   BigInt?   @map("session_id")
  senderId    BigInt?   @map("sender_id")
  messageText String?   @map("message_text") @db.Text
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  isRead      Boolean?  @default(false) @map("is_read")

  // Relations
  session ChatSession? @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  sender  AppUser?     @relation("SenderMessages", fields: [senderId], references: [userId])

  @@map("chat_message")
}

model ChatSession {
  sessionId     BigInt    @id @default(autoincrement()) @map("session_id")
  buyerId       BigInt?   @map("buyer_id")
  sellerId      BigInt?   @map("seller_id")
  startedAt     DateTime? @default(now()) @map("started_at") @db.Timestamptz(6)
  lastMessageAt DateTime? @map("last_message_at") @db.Timestamptz(6)

  // Relations
  buyer    AppUser?      @relation("BuyerSessions", fields: [buyerId], references: [userId])
  seller   AppUser?      @relation("SellerSessions", fields: [sellerId], references: [userId])
  messages ChatMessage[]

  @@map("chat_session")
}

model CoinHistory {
  historyId    BigInt    @id @default(autoincrement()) @map("history_id")
  userId       BigInt?   @map("user_id")
  changeAmount Decimal   @map("change_amount") @db.Decimal(12, 2)
  reason       String?   @db.Text
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user AppUser? @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("coin_history")
}

model FollowedShop {
  followId   BigInt    @id @default(autoincrement()) @map("follow_id")
  userId     BigInt?   @map("user_id")
  shopId     BigInt?   @map("shop_id")
  followedAt DateTime? @default(now()) @map("followed_at") @db.Timestamptz(6)

  // Relations
  user AppUser? @relation(fields: [userId], references: [userId], onDelete: Cascade)
  shop Shop?    @relation(fields: [shopId], references: [shopId], onDelete: Cascade)

  @@unique([userId, shopId])
  @@map("followed_shop")
}

model Order {
  orderId     BigInt    @id @default(autoincrement()) @map("order_id")
  buyerId     BigInt?   @map("buyer_id")
  shopId      BigInt?   @map("shop_id")
  totalAmount Decimal   @map("total_amount") @db.Decimal(12, 2)
  status      String    @default("pending") @db.VarChar(40)
  voucherId   BigInt?   @map("voucher_id")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  buyer       AppUser?        @relation("BuyerOrders", fields: [buyerId], references: [userId], onDelete: SetNull)
  shop        Shop?           @relation(fields: [shopId], references: [shopId], onDelete: SetNull)
  voucher     Voucher?        @relation(fields: [voucherId], references: [voucherId])
  orderItems  OrderItem[]
  reviews     ProductReview[]
  shipments   Shipment[]

  @@index([buyerId], name: "idx_order_buyer")
  @@map("order")
}

model OrderItem {
  orderItemId BigInt  @id @default(autoincrement()) @map("order_item_id")
  orderId     BigInt? @map("order_id")
  productId   BigInt? @map("product_id")
  variationId BigInt? @map("variation_id")
  quantity    Int     @default(1)
  unitPrice   Decimal @map("unit_price") @db.Decimal(12, 2)
  subtotal    Decimal @db.Decimal(12, 2)

  // Relations
  order     Order?            @relation(fields: [orderId], references: [orderId], onDelete: Cascade)
  product   Product?          @relation(fields: [productId], references: [productId])
  variation ProductVariation? @relation(fields: [variationId], references: [variationId])

  @@map("order_item")
}

model PaymentMethod {
  paymentId   BigInt    @id @default(autoincrement()) @map("payment_id")
  userId      BigInt?   @map("user_id")
  methodType  String?   @map("method_type") @db.VarChar(50)
  provider    String?   @db.VarChar(120)
  detailsJson String?   @map("details_json") @db.Text
  isDefault   Boolean?  @default(false) @map("is_default")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user AppUser? @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("payment_method")
}

model Product {
  productId   BigInt    @id @default(autoincrement()) @map("product_id")
  shopId      BigInt?   @map("shop_id")
  categoryId  BigInt?   @map("category_id")
  name        String    @db.VarChar(255)
  description String?   @db.Text
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  shop            Shop[]             @relation("ShopProducts")
  category        Category?          @relation(fields: [categoryId], references: [categoryId], onDelete: SetNull)
  cartItems       CartItem[]
  images          ProductImage[]
  orderItems      OrderItem[]
  recentlyViewed  RecentlyViewed[]
  reviews         ProductReview[]
  variations      ProductVariation[]
  wishlistItems   WishlistItem[]

  @@index([shopId], name: "idx_product_shop")
  @@map("product")
}

model ProductImage {
  imageId   BigInt  @id @default(autoincrement()) @map("image_id")
  productId BigInt? @map("product_id")
  url       String  @db.Text
  altText   String? @map("alt_text") @db.Text
  ordering  Int?    @default(0)

  // Relations
  product Product? @relation(fields: [productId], references: [productId], onDelete: Cascade)

  @@map("product_image")
}

model ProductReview {
  reviewId  BigInt    @id @default(autoincrement()) @map("review_id")
  productId BigInt?   @map("product_id")
  orderId   BigInt?   @map("order_id")
  userId    BigInt?   @map("user_id")
  rating    Int?
  comment   String?   @db.Text
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  product Product?  @relation(fields: [productId], references: [productId], onDelete: Cascade)
  order   Order?    @relation(fields: [orderId], references: [orderId])
  user    AppUser?  @relation(fields: [userId], references: [userId], onDelete: SetNull)

  @@map("product_review")
}

model ProductVariation {
  variationId   BigInt    @id @default(autoincrement()) @map("variation_id")
  productId     BigInt?   @map("product_id")
  sku           String?   @db.VarChar(80)
  variationName String?   @map("variation_name") @db.VarChar(255)
  stock         Int       @default(0)
  price         Decimal   @db.Decimal(12, 2)
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  product       Product[]       @relation("ProductVariations")
  cartItems     CartItem[]
  orderItems    OrderItem[]
  wishlistItems WishlistItem[]

  @@index([productId], name: "idx_variation_product")
  @@map("product_variation")
}

model RecentlyViewed {
  viewedId  BigInt    @id @default(autoincrement()) @map("viewed_id")
  userId    BigInt?   @map("user_id")
  productId BigInt?   @map("product_id")
  viewedAt  DateTime? @default(now()) @map("viewed_at") @db.Timestamptz(6)

  // Relations
  user    AppUser?  @relation(fields: [userId], references: [userId], onDelete: Cascade)
  product Product?  @relation(fields: [productId], references: [productId])

  @@map("recently_viewed")
}

model Shipment {
  shipmentId  BigInt    @id @default(autoincrement()) @map("shipment_id")
  orderId     BigInt?   @map("order_id")
  trackingNo  String?   @map("tracking_no") @db.VarChar(120)
  carrier     String?   @db.VarChar(120)
  shippedAt   DateTime? @map("shipped_at") @db.Timestamptz(6)
  deliveredAt DateTime? @map("delivered_at") @db.Timestamptz(6)

  // Relations
  order Order? @relation(fields: [orderId], references: [orderId], onDelete: Cascade)

  @@map("shipment")
}

model Shop {
  shopId       BigInt   @id @default(autoincrement()) @map("shop_id")
  ownerUserId  BigInt?  @map("owner_user_id")
  shopName     String   @map("shop_name") @db.VarChar(150)
  description  String?  @db.Text
  ratingAvg    Decimal? @default(0) @map("rating_avg") @db.Decimal(3, 2)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  owner         AppUser?       @relation(fields: [ownerUserId], references: [userId], onDelete: Cascade)
  followedShops FollowedShop[]
  orders        Order[]
  products      Product[]      @relation("ShopProducts")

  @@map("shop")
}

model UserVoucher {
  userVoucherId BigInt    @id @default(autoincrement()) @map("user_voucher_id")
  userId        BigInt?   @map("user_id")
  voucherId     BigInt?   @map("voucher_id")
  claimedAt     DateTime? @default(now()) @map("claimed_at") @db.Timestamptz(6)
  usedAt        DateTime? @map("used_at") @db.Timestamptz(6)

  // Relations
  user    AppUser? @relation(fields: [userId], references: [userId], onDelete: Cascade)
  voucher Voucher? @relation(fields: [voucherId], references: [voucherId], onDelete: Cascade)

  @@map("user_voucher")
}

model Voucher {
  voucherId   BigInt    @id @default(autoincrement()) @map("voucher_id")
  code        String    @unique @db.VarChar(50)
  discountPct Decimal?  @map("discount_pct") @db.Decimal(5, 2)
  discountAmt Decimal?  @map("discount_amt") @db.Decimal(12, 2)
  minOrderAmt Decimal?  @default(0) @map("min_order_amt") @db.Decimal(12, 2)
  validFrom   DateTime? @default(now()) @map("valid_from") @db.Timestamptz(6)
  validTo     DateTime? @map("valid_to") @db.Timestamptz(6)
  active      Boolean?  @default(true)
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  orders       Order[]
  userVouchers UserVoucher[]

  @@map("voucher")
}

model WishlistItem {
  wishlistId  BigInt    @id @default(autoincrement()) @map("wishlist_id")
  userId      BigInt?   @map("user_id")
  productId   BigInt?   @map("product_id")
  variationId BigInt?   @map("variation_id")
  addedAt     DateTime? @default(now()) @map("added_at") @db.Timestamptz(6)

  // Relations
  user      AppUser?          @relation(fields: [userId], references: [userId], onDelete: Cascade)
  product   Product?          @relation(fields: [productId], references: [productId])
  variation ProductVariation? @relation(fields: [variationId], references: [variationId])

  @@unique([userId, productId, variationId])
  @@map("wishlist_item")
}
