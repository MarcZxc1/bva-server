// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

// -------------------------------------
// DATASOURCE
// -------------------------------------
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------------------------
// ENUMS
// -------------------------------------

enum Role {
  ADMIN
  SELLER
  BUYER
  ANALYST
}

enum Platform {
  SHOPEE
  LAZADA
  TIKTOK
  OTHER
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

// -------------------------------------
// MODELS
// -------------------------------------

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String?
  googleId  String?  @unique
  facebookId String? @unique
  shopeeId  String?  @unique
  name      String?
  firstName String?
  lastName  String?
  role      Role     @default(SELLER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shops     Shop[]
  notifications Notification[]
  socialMediaAccounts SocialMediaAccount[]
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  type      String   // e.g., 'info', 'warning', 'success'
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Shop {
  id        String   @id @default(uuid())
  name      String
  owner     User     @relation(fields: [ownerId], references: [id])
  ownerId   String
  createdAt DateTime @default(now())

  products     Product[]
  sales        Sale[]
  campaigns    Campaign[]
  integrations Integration[]
}

model Product {
  id          String   @id @default(uuid())
  shop        Shop     @relation(fields: [shopId], references: [id])
  shopId      String
  sku         String
  name        String
  description String?
  price       Float
  cost        Float?
  expiryDate  DateTime?
  category    String?
  imageUrl    String?
  stock       Int      @default(0)
  externalId  String?  // ID from external system (Shopee-Clone)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  inventories Inventory[]
  forecasts   Forecast[]

  @@unique([shopId, sku])
  @@unique([shopId, externalId])
}

model Inventory {
  id          String         @id @default(uuid())
  product     Product        @relation(fields: [productId], references: [id])
  productId   String
  quantity    Int            @default(0)
  threshold   Int            @default(10)
  batchNumber String?
  location    String?
  updatedAt   DateTime       @updatedAt

  logs InventoryLog[]
}

model InventoryLog {
  id           String     @id @default(uuid())
  inventory    Inventory  @relation(fields: [inventoryId], references: [id])
  inventoryId  String
  delta        Int
  reason       String?
  timestamp    DateTime   @default(now())
}

model Sale {
  id               String    @id @default(uuid())
  shop             Shop      @relation(fields: [shopId], references: [id])
  shopId           String
  platform         Platform
  platformOrderId  String?
  externalId       String?   // ID from external system (Shopee-Clone)
  items            Json
  total            Float
  revenue          Float?    // Total revenue from this sale
  profit           Float?    // Profit margin
  customerName     String?
  customerEmail    String?
  status           String    @default("completed")
  createdAt        DateTime  @default(now())

  @@unique([platform, platformOrderId])
  @@unique([shopId, externalId])
}

model Forecast {
  id         String   @id @default(uuid())
  product    Product  @relation(fields: [productId], references: [id])
  productId  String
  date       DateTime
  predicted  Int
  method     String
  createdAt  DateTime @default(now())

  @@unique([productId, date, method])
}

model Campaign {
  id          String          @id @default(uuid())
  shop        Shop            @relation(fields: [shopId], references: [id])
  shopId      String
  name        String
  content     Json
  imageUrl    String?         // Base64 data URL or external URL for generated ad image
  status      CampaignStatus  @default(DRAFT)
  scheduledAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model Integration {
  id        String    @id @default(uuid())
  shop      Shop      @relation(fields: [shopId], references: [id])
  shopId    String
  platform  Platform
  settings  Json
  createdAt DateTime  @default(now())

  @@unique([shopId, platform])
}

model SocialMediaAccount {
  id                String   @id @default(uuid())
  user              User     @relation(fields: [userId], references: [id])
  userId            String
  platform          String   // 'facebook', 'instagram', etc.
  accessToken       String   @db.Text
  refreshToken      String?  @db.Text
  pageId            String?  // Facebook Page ID
  accountId         String?  // Instagram Business Account ID
  expiresAt         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, platform])
}
